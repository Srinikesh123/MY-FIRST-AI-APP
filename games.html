<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mini-Games - voidzen.ai</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }

        h1 {
            color: #667eea;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            display: inline-block;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .games-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .game-card {
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            text-align: center;
            transition: all 0.2s;
        }

        .game-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .game-card h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .game-reward {
            margin: 10px 0;
            color: #666;
            font-size: 14px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            margin-top: 10px;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-primary:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .game-card.coming-soon {
            opacity: 0.6;
        }

        .coming-soon-badge {
            display: inline-block;
            background: #f59e0b;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-top: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéÆ Mini-Games</h1>
            <a href="index.html" class="btn btn-secondary">‚Üê Back to App</a>
        </div>

        <div class="games-grid" id="gamesGrid">
            <div style="padding: 40px; text-align: center; color: #6b7280;">
                <div style="font-size: 48px; margin-bottom: 16px;">üéÆ</div>
                <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px; color: #374151;">Loading games...</div>
            </div>
        </div>
    </div>

    <script>
        window.SUPABASE_URL = 'https://vexmydzwlongsqnzamdk.supabase.co';
        window.SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZleG15ZHp3bG9uZ3NxbnphbWRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5ODQzNTEsImV4cCI6MjA4MTU2MDM1MX0.2sswoFrrYryzpDircWi2HtRFiE5x5Pp-N_oUYunPO1o';
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="games.js"></script>
    <script>
        // Ensure Supabase client is initialized exactly once
        if (!window.__gamesSupabaseClient) {
            if (typeof window.supabase === 'undefined') {
                console.error('‚ùå Supabase SDK not loaded');
            } else {
                window.__gamesSupabaseClient = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
            }
        }
        const supabaseClient = window.__gamesSupabaseClient;
        let currentUserId = null;
        let gameManager = null;

        async function init() {
            try {
                console.log('üéÆ Initializing games page...');
                console.log('üéÆ Supabase client exists:', !!supabaseClient);
                
                const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
                
                if (sessionError) {
                    console.error('‚ùå Session error:', sessionError);
                    throw new Error('Failed to get session: ' + sessionError.message);
                }
                
                if (!session) {
                    console.log('‚ö†Ô∏è No session, redirecting to login...');
                    window.location.href = 'login.html';
                    return;
                }
                
                currentUserId = session.user.id;
                console.log('‚úÖ User authenticated:', currentUserId);
                
                // Initialize GameManager
                if (typeof GameManager !== 'undefined') {
                    gameManager = new GameManager(supabaseClient, currentUserId);
                    console.log('‚úÖ GameManager initialized');
                } else {
                    console.error('‚ùå GameManager not loaded. Make sure games.js is included.');
                    document.getElementById('gamesGrid').innerHTML = `
                        <div style="padding: 20px; text-align: center; color: #ef4444;">
                            <strong>Error:</strong> Game system not loaded. Please refresh the page.
                        </div>
                    `;
                    return;
                }
                
                console.log('üéÆ Loading games...');
                await loadGames();
            } catch (error) {
                console.error('‚ùå Init error:', error);
                const grid = document.getElementById('gamesGrid');
                if (grid) {
                    grid.innerHTML = `
                        <div style="padding: 20px; text-align: center; color: #ef4444;">
                            <strong>Initialization Error:</strong><br>
                            ${error.message || 'Unknown error'}<br>
                            <button onclick="location.reload()" style="margin-top: 10px; padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">Reload Page</button>
                        </div>
                    `;
                }
            }
        }

        async function loadGames() {
            const startTime = Date.now();
            const gamesGrid = document.getElementById('gamesGrid');
            const MAX_LOAD_TIME = 1500; // 1.5 seconds max
            
            if (!gamesGrid) {
                console.error('‚ùå gamesGrid element not found');
                return;
            }
            
            // Set timeout to abort if loading takes too long
            const timeoutId = setTimeout(() => {
                const elapsed = Date.now() - startTime;
                gamesGrid.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #ef4444;">
                        <strong>Load Timeout</strong><br>
                        Games failed to load within ${MAX_LOAD_TIME}ms<br>
                        <small>Time elapsed: ${elapsed}ms</small><br>
                        <button onclick="loadGames()" style="margin-top: 10px; padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">Retry</button>
                    </div>
                `;
            }, MAX_LOAD_TIME);
            
            try {
                console.log('üéÆ Starting games query...');
                
                if (!supabaseClient) {
                    clearTimeout(timeoutId);
                    throw new Error('Supabase not initialized');
                }
                
                // Query games table - use direct query
                console.log('üéÆ Querying Supabase games table...');
                const queryResult = await supabaseClient
                    .from('games')
                    .select('id, name, reward_coins, reward_tokens, description, created_at')
                    .order('name');
                
                clearTimeout(timeoutId);
                
                const { data: games, error } = queryResult;
                console.log('üéÆ Query result:', { hasData: !!games, dataLength: games?.length, hasError: !!error });
                
                if (error) {
                    console.error('‚ùå SUPABASE ERROR:', error);
                    console.error('  - code:', error.code);
                    console.error('  - message:', error.message);
                    console.error('  - details:', error.details);
                    console.error('  - hint:', error.hint);
                    
                    // Try fallback: use server API
                    console.log('üîÑ Trying server API fallback...');
                    try {
                        const response = await fetch('http://localhost:3000/api/games/list');
                        if (response.ok) {
                            const serverData = await response.json();
                            if (serverData.games && serverData.games.length > 0) {
                                console.log('‚úÖ Server API returned games:', serverData.games.length);
                                clearTimeout(timeoutId);
                                renderGames(serverData.games);
                                return;
                            }
                        }
                    } catch (apiError) {
                        console.error('‚ùå Server API also failed:', apiError);
                    }
                    
                    // Show exact error
                    gamesGrid.innerHTML = `
                        <div style="padding: 20px; text-align: center; color: #ef4444;">
                            <strong>Database Error:</strong><br>
                            ${error.message || 'Unknown error'}<br>
                            <small>Code: ${error.code || 'N/A'}</small><br>
                            <small>Check console for details</small><br>
                            <button onclick="loadGames()" style="margin-top: 10px; padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">Retry</button>
                        </div>
                    `;
                    return;
                }
                
                clearTimeout(timeoutId);
                const finalLoadTime = Date.now() - startTime;
                console.log(`‚úÖ Query completed in ${finalLoadTime}ms`);
                console.log(`‚úÖ Games count: ${games?.length || 0}`);
                
                // Check if games is null, undefined, or empty array
                if (!games) {
                    console.error('‚ùå Games data is null or undefined');
                    gamesGrid.innerHTML = `
                        <div style="padding: 20px; text-align: center; color: #ef4444;">
                            <strong>Error:</strong> Query returned null<br>
                            <small>Check RLS policies and table permissions</small>
                        </div>
                    `;
                    return;
                }
                
                if (!Array.isArray(games)) {
                    console.error('‚ùå Games data is not an array:', typeof games);
                    gamesGrid.innerHTML = `
                        <div style="padding: 20px; text-align: center; color: #ef4444;">
                            <strong>Error:</strong> Invalid data format<br>
                            <small>Expected array, got: ${typeof games}</small>
                        </div>
                    `;
                    return;
                }
                
                if (games.length === 0) {
                    console.log('‚ö†Ô∏è Games array is empty - showing empty state');
                    gamesGrid.innerHTML = `
                        <div style="padding: 40px; text-align: center; color: #6b7280;">
                            <div style="font-size: 48px; margin-bottom: 16px;">üéÆ</div>
                            <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px; color: #374151;">No games available yet</div>
                            <div style="font-size: 14px; color: #6b7280;">Games will appear here when added to the database</div>
                        </div>
                    `;
                } else {
                    console.log(`‚úÖ Rendering ${games.length} games`);
                    renderGames(games);
                }
            } catch (error) {
                const loadTime = Date.now() - startTime;
                console.error(`‚ùå EXCEPTION in loadGames (${loadTime}ms):`, error);
                console.error('  - name:', error.name);
                console.error('  - message:', error.message);
                console.error('  - stack:', error.stack);
                
                gamesGrid.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #ef4444;">
                        <strong>Error loading games:</strong><br>
                        ${error.message || 'Unknown error'}<br>
                        <small>Load time: ${loadTime}ms</small><br>
                        <small>Check browser console for details</small>
                    </div>
                `;
            }
        }

        function renderGames(games) {
            const grid = document.getElementById('gamesGrid');
            
            if (!gameManager) {
                grid.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #ef4444;">
                        <strong>Error:</strong> Game system not initialized. Please refresh the page.
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = games.map(game => {
                const isPlayable = gameManager.isGamePlayable(game.name);
                const cardClass = isPlayable ? 'game-card' : 'game-card coming-soon';
                
                return `
                    <div class="${cardClass}">
                        <h3>${escapeHtml(game.name)}</h3>
                        <p class="game-reward">Reward: ü™ô ${game.reward_coins || 0} coins${game.reward_tokens ? ` + ${game.reward_tokens} tokens` : ''}</p>
                        ${isPlayable 
                            ? `<button class="btn-primary" onclick="playGame('${game.id}', '${escapeHtml(game.name)}', ${game.reward_coins || 0}, ${game.reward_tokens || 0})">Play Now</button>`
                            : `<button class="btn-primary" disabled>Coming Soon</button>
                               <div class="coming-soon-badge">üöß Coming Soon</div>`
                        }
                    </div>
                `;
            }).join('');
        }

        function playGame(gameId, gameName, rewardCoins, rewardTokens) {
            if (!gameManager) {
                alert('Game system not initialized. Please refresh the page.');
                return;
            }
            
            gameManager.showGameModal(gameId, gameName, rewardCoins, rewardTokens);
        }

        // submitGameResult is now handled by GameManager
        // This function is kept for backward compatibility but should not be used directly

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Make function global for onclick
        window.openGame = playGame;

        init();
    </script>
</body>
</html>



<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elite Coding Agent</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #0d0d15;
            --bg-tertiary: #1a1a2a;
            --accent-blue: #00d9ff;
            --accent-green: #10b981;
            --accent-purple: #8b5cf6;
            --text-primary: #e0e0e0;
            --text-secondary: #888;
            --border: #2a2a4a;
            --success: #1a3a1a;
            --warning: #3a3a1a;
            --error: #3a1a1a;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; 
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }
        
        .layout {
            display: grid;
            grid-template-columns: 220px 1fr 320px; /* Removed preview column */
            grid-template-rows: 50px 1fr;
            height: 100vh;
            background: var(--bg-tertiary);
        }
        
        /* Preview Overlay - Hidden by default */
        .preview-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .preview-overlay.active {
            display: flex;
        }
        
        .preview-window {
            width: 90vw;
            height: 90vh;
            background: #fff;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 0 1px rgba(255,255,255,0.1), 0 25px 50px -12px rgba(0,0,0,0.5);
        }
        
        .preview-header {
            padding: 16px 20px;
            background: #161b22;
            color: #8b949e;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #30363d;
        }
        
        .preview-title {
            font-weight: 600;
            font-size: 14px;
        }
        
        .preview-controls-modal {
            display: flex;
            gap: 8px;
        }
        
        .preview-control-btn {
            background: #21262d;
            border: 1px solid #30363d;
            color: #c9d1d9;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .preview-control-btn:hover {
            background: #30363d;
            color: #ffffff;
        }
        
        .preview-control-btn.active {
            background: #238636;
            border-color: #238636;
            color: #ffffff;
        }
        
        .close-preview {
            background: #da3633;
            border: 1px solid #da3633;
            color: #ffffff;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }
        
        .close-preview:hover {
            background: #f85149;
            border-color: #f85149;
        }
        
        .preview-content {
            flex: 1;
            background: #f6f8fa;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: auto;
        }
        
        .preview-frame-full {
            width: 100%;
            height: 100%;
            border: none;
            background: #fff;
        }
        
        .preview-frame-full.mobile {
            width: 375px;
            height: 667px;
            border-radius: 20px;
            box-shadow: 0 0 0 10px #1a1a1a, 0 25px 50px -12px rgba(0,0,0,0.5);
        }
        
        .preview-frame-full.tablet {
            width: 768px;
            height: 1024px;
            border-radius: 12px;
            box-shadow: 0 0 0 8px #1a1a1a, 0 25px 50px -12px rgba(0,0,0,0.5);
        }
        
        /* Header */
        .header {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #161b22 0%, #0d1117 100%);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            border-bottom: 1px solid var(--border);
        }
        
        .logo { 
            font-weight: 700; 
            font-size: 16px; 
            color: var(--accent-blue);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .project-input {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 6px 12px;
            border-radius: 6px;
            width: 160px;
            font-size: 13px;
        }
        
        .status {
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 12px;
            background: var(--success);
            color: var(--accent-green);
        }
        
        .status.error { background: var(--error); color: #f87171; }
        .status.warning { background: var(--warning); color: #fbbf24; }
        
        .btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s ease;
        }
        
        .btn:hover { 
            background: #2a2a4a; 
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .btn:active { transform: translateY(0); }
        .btn.primary { background: linear-gradient(135deg, var(--accent-blue) 0%, #00a8cc 100%); color: #000; font-weight: 600; }
        .btn.new { background: linear-gradient(135deg, var(--accent-purple) 0%, #7c3aed 100%); color: white; }
        
        /* Panels */
        .panel {
            background: var(--bg-secondary);
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border);
        }
        
        .panel:last-child { border-right: none; border-left: 1px solid var(--border); }
        
        .panel-header {
            padding: 12px 16px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-secondary);
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* Persistent User Info Box */
        .persistent-user-info {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            padding: 12px 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            font-weight: 500;
            color: #1a1a1a;
        }
        
        .user-avatar-mini {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        
        .user-details {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .user-name-display {
            font-weight: 600;
            font-size: 13px;
        }
        
        .user-status {
            font-size: 11px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
        }
        .file-tree {
            flex: 1;
            overflow-y: auto;
            padding: 6px 0;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            padding: 8px 16px;
            cursor: pointer;
            gap: 8px;
            font-size: 13px;
            border-left: 2px solid transparent;
        }
        
        .file-item:hover { background: var(--bg-tertiary); }
        .file-item.active { 
            background: #1a2a4a; 
            border-left-color: var(--accent-blue);
            color: var(--accent-blue);
        }
        
        .file-delete {
            opacity: 0;
            background: none;
            border: none;
            color: #f87171;
            cursor: pointer;
            margin-left: auto;
            font-size: 14px;
        }
        
        .file-item:hover .file-delete { opacity: 1; }
        
        .empty-state {
            padding: 24px;
            text-align: center;
            color: var(--text-secondary);
            font-size: 12px;
        }
        
        /* Editor */
        .editor-container {
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
        }
        
        .tabs {
            display: flex;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            overflow-x: auto;
        }
        
        .tab {
            padding: 10px 16px;
            font-size: 12px;
            color: var(--text-secondary);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .tab:hover { color: var(--text-primary); background: var(--bg-tertiary); }
        .tab.active { 
            color: var(--accent-blue); 
            border-bottom-color: var(--accent-blue);
            background: var(--bg-primary);
        }
        
        .editor {
            flex: 1;
            position: relative;
        }
        
        .editor textarea {
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            border: none;
            color: var(--text-primary);
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.6;
            padding: 16px;
            resize: none;
            outline: none;
        }
        
        .editor-footer {
            padding: 6px 16px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            font-size: 11px;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
        }
        
        /* Preview */
        .preview-container {
            background: #fff;
            display: flex;
            flex-direction: column;
        }
        
        .preview-controls {
            display: flex;
            gap: 6px;
        }
        
        .preview-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            cursor: pointer;
        }
        
        .preview-btn:hover { background: #2a2a4a; color: var(--text-primary); }
        .preview-btn.active { background: var(--accent-green); color: #000; }
        
        .preview-area {
            flex: 1;
            background: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .preview-frame {
            width: 100%;
            height: 100%;
            border: none;
            background: #fff;
        }
        
        .preview-frame.mobile {
            width: 375px;
            height: 667px;
            border-radius: 20px;
            box-shadow: 0 0 0 10px #000, 0 20px 60px rgba(0,0,0,0.4);
        }
        
        .preview-frame.tablet {
            width: 768px;
            height: 500px;
            border-radius: 12px;
            box-shadow: 0 0 0 8px #000, 0 20px 60px rgba(0,0,0,0.4);
        }
        
        .preview-placeholder {
            color: #666;
            text-align: center;
        }
        
        /* Chat */
        .chat-container {
            background: var(--bg-secondary);
            display: flex;
            flex-direction: column;
        }
        
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }
        
        .message {
            margin-bottom: 16px;
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.bot {
            background: linear-gradient(135deg, #161b22 0%, #1a2a3e 100%);
            border-radius: 12px;
            padding: 14px;
            border-left: 3px solid var(--accent-blue);
        }
        
        .message.user {
            background: linear-gradient(135deg, #1a3a2a 0%, #1a4a3a 100%);
            border-radius: 12px;
            padding: 14px;
            margin-left: 20px;
        }
        
        .message-sender {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--accent-blue);
            margin-bottom: 8px;
        }
        
        .message.user .message-sender { color: var(--accent-green); }
        
        .message-content {
            font-size: 13px;
            line-height: 1.6;
        }
        
        .message-content code {
            background: var(--bg-primary);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            font-family: 'Fira Code', monospace;
        }
        
        .message-content pre {
            background: var(--bg-primary);
            padding: 14px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 10px 0;
            font-size: 11px;
            font-family: 'Fira Code', monospace;
        }
        
        .message-content strong { color: var(--accent-blue); }
        
        .input-area {
            border-top: 1px solid var(--border);
            background: var(--bg-primary);
            padding: 14px;
        }
        
        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 12px;
        }
        
        .quick-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 5px 10px;
            border-radius: 16px;
            font-size: 11px;
            cursor: pointer;
        }
        
        .quick-btn:hover { 
            background: #2a2a4a; 
            border-color: var(--accent-blue);
        }
        
        .input-row {
            display: flex;
            gap: 8px;
        }
        
        .input-field {
            flex: 1;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 13px;
            outline: none;
        }
        
        .input-field:focus { border-color: var(--accent-blue); }
        
        .send-btn {
            background: linear-gradient(135deg, var(--accent-blue) 0%, #00a8cc 100%);
            border: none;
            color: #000;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 13px;
        }
        
        .send-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,217,255,0.4); }
        .send-btn:disabled { background: var(--bg-tertiary); color: var(--text-secondary); transform: none; }
        
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 8px 0;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--accent-blue);
            border-radius: 50%;
            animation: bounce 1.4s infinite;
        }
        
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes bounce {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.5; }
            30% { transform: translateY(-8px); opacity: 1; }
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-overlay.active { display: flex; }
        
        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            width: 90%;
            max-width: 450px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal h3 {
            color: var(--accent-blue);
            margin-bottom: 16px;
            font-size: 18px;
        }
        
        .modal-item {
            padding: 12px 16px;
            background: var(--bg-primary);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-item:hover { background: #1a2a4a; }
        
        /* Scrollbars */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-primary); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #444; }
        
        @media (max-width: 1200px) {
            .layout { grid-template-columns: 180px 1fr 1fr 280px; }
        }
    </style>
</head>
<body>
    <div class="layout">
        <!-- Header -->
        <header class="header">
            <div class="logo">‚ö° Elite Code Agent</div>
            <div class="controls">
                <input type="text" class="project-input" id="projectName" value="elite-project" placeholder="Project name">
                <span class="status" id="statusIndicator">READY</span>
                <button class="btn new" onclick="app.newProject()">‚ú® New</button>
                <button class="btn" onclick="app.loadProjects()">üìÇ Load</button>
                <button class="btn" onclick="app.saveProject()">üíæ Save</button>
                <button class="btn primary" onclick="app.downloadProject()">‚¨áÔ∏è ZIP</button>
            </div>
        </header>

        <!-- File Explorer -->
        <aside class="panel">
            <div class="panel-header">
                üìÅ Files
                <button class="btn" onclick="app.createFile()" style="padding:2px 8px;font-size:10px">+ Add</button>
            </div>
            <div class="file-tree" id="fileTree">
                <div class="empty-state">No files yet<br>Ask me to build something!</div>
            </div>
        </aside>

        <!-- Code Editor -->
        <main class="editor-container">
            <div class="panel-header">üíª Code Editor</div>
            <div class="tabs" id="editorTabs">
                <div class="tab active" data-file="welcome">üëã Welcome</div>
            </div>
            <div class="editor">
                <textarea id="codeEditor" spellcheck="false" placeholder="// Welcome! Ask the AI to build something.&#10;// Your code will appear here."></textarea>
            </div>
            <div class="editor-footer">
                <span id="fileInfo">No file selected</span>
                <span id="cursorPosition">Ln 1, Col 1</span>
            </div>
        </main>

        <!-- Chat -->
        <aside class="chat-container">
            <div class="panel-header">
                ü§ñ AI Assistant
                <button class="btn" onclick="app.togglePreview()" style="padding:2px 8px;font-size:10px;background:var(--accent-blue);color:#000;border:none;">‚ñ∂Ô∏è Preview</button>
            </div>
            <div class="messages" id="chatMessages">
                <div class="message bot">
                    <div class="message-sender">üß† Agent</div>
                    <div class="message-content">
                        <strong>Ready to build!</strong><br>
                        Tell me what you want and I'll create production-ready code with all files.
                    </div>
                </div>
            </div>
            <div class="input-area">
                <div class="quick-actions">
                    <button class="quick-btn" onclick="app.quickAction('Build a landing page')">üè† Landing</button>
                    <button class="quick-btn" onclick="app.quickAction('Create a todo app')">üìã Todo</button>
                    <button class="quick-btn" onclick="app.quickAction('Make a calculator')">üßÆ Calc</button>
                    <button class="quick-btn" onclick="app.quickAction('Build a portfolio')">üë§ Portfolio</button>
                </div>
                <div class="input-row">
                    <input type="text" class="input-field" id="userInput" placeholder="What do you want to build?" onkeypress="if(event.key==='Enter' && !event.shiftKey) { event.preventDefault(); app.sendMessage(); }">
                    <button class="send-btn" id="sendButton" onclick="app.sendMessage()">Build</button>
                </div>
            </div>
        </aside>
    </div>

    <!-- Load Modal -->
    <div class="modal-overlay" id="loadModal">
        <div class="modal">
            <h3>üìÇ Load Project</h3>
            <div id="projectList" style="max-height: 300px; overflow-y: auto;"></div>
            <div style="margin-top: 16px; display: flex; justify-content: flex-end;">
                <button class="btn" onclick="app.closeModal()">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Preview Overlay Modal -->
    <div class="preview-overlay" id="previewOverlay">
        <div class="preview-window">
            <div class="preview-header">
                <div class="preview-title">üñºÔ∏è Live Preview</div>
                <div class="preview-controls-modal">
                    <button class="preview-control-btn active" data-mode="desktop" onclick="app.setPreviewModeModal('desktop')">üíª Desktop</button>
                    <button class="preview-control-btn" data-mode="tablet" onclick="app.setPreviewModeModal('tablet')">üì± Tablet</button>
                    <button class="preview-control-btn" data-mode="mobile" onclick="app.setPreviewModeModal('mobile')">üì± Mobile</button>
                    <button class="preview-control-btn" onclick="app.refreshPreviewModal()">üîÑ Refresh</button>
                    <button class="close-preview" onclick="app.closePreview()">√ó</button>
                </div>
            </div>
            <div class="preview-content">
                <iframe id="previewFrameModal" class="preview-frame-full"></iframe>
            </div>
        </div>
    </div>
    
    <!-- Persistent User Info -->
    <div class="persistent-user-info" id="persistentUserInfo">
        <div class="user-avatar-mini">üë§</div>
        <div class="user-details">
            <div class="user-name-display" id="persistentUserName">Loading...</div>
            <div class="user-status">
                <div class="status-indicator"></div>
                <span id="persistentUserStatus">Connected</span>
            </div>
        </div>
    </div>

<script>
// ==================== CORE APPLICATION CLASS ====================
class CodingAgent {
    constructor() {
        // State management
        this.state = {
            project: { id: null, name: 'elite-project', files: {}, conversation: [] },
            currentFile: null,
            isProcessing: false,
            hasUnsavedChanges: false,
            previewMode: 'desktop',
            supabase: null,
            userId: null,
            previewOpen: false
        };
        
        // DOM Elements cache
        this.elements = {};
        this.cacheDOMElements();
        
        // Initialize when DOM is ready
        this.init();
    }
    
    // ==================== INITIALIZATION ====================
    async init() {
        try {
            console.log('üöÄ Initializing Elite Coding Agent...');
            this.updateStatus('INITIALIZING', 'warning');
            
            // Fetch configuration from server
            const config = await this.fetchConfig();
            if (!config.supabaseUrl || !config.supabaseAnonKey) {
                throw new Error('Supabase not configured on server');
            }
            
            // Initialize Supabase client
            this.state.supabase = window.supabase.createClient(
                config.supabaseUrl, 
                config.supabaseAnonKey
            );
            
            // Get current user
            const { data: { user } } = await this.state.supabase.auth.getUser();
            if (user) {
                this.state.userId = user.id;
                console.log('‚úÖ Authenticated user:', this.state.userId);
                await this.autoLoadLastProject();
            }
            
            // Update persistent user info
            this.updatePersistentUserInfo();
            
            this.setupEventListeners();
            this.updateStatus('READY');
            console.log('‚úÖ Initialization complete');
            
        } catch (error) {
            console.error('‚ùå Initialization failed:', error);
            this.updateStatus('ERROR', 'error');
            this.addMessage('bot', `‚ùå <strong>Startup Error:</strong> ${error.message}`);
        }
    }
    
    cacheDOMElements() {
        const ids = [
            'projectName', 'statusIndicator', 'fileTree', 'codeEditor', 
            'editorTabs', 'fileInfo', 'cursorPosition', 'previewArea',
            'previewPlaceholder', 'previewFrame', 'chatMessages', 
            'userInput', 'sendButton', 'loadModal', 'projectList',
            'persistentUserName', 'persistentUserStatus'  // Added persistent user elements
        ];
        
        ids.forEach(id => {
            this.elements[id] = document.getElementById(id);
            if (!this.elements[id]) {
                console.warn(`‚ö†Ô∏è Element not found: ${id}`);
            }
        });
        
        // Update persistent user info
        this.updatePersistentUserInfo();
    }
    
    setupEventListeners() {
        // Code editor changes
        this.elements.codeEditor?.addEventListener('input', () => {
            this.handleCodeChange();
        });
        
        // Project name changes
        this.elements.projectName?.addEventListener('change', (e) => {
            this.state.project.name = e.target.value;
            this.state.hasUnsavedChanges = true;
            this.updateStatus('UNSAVED', 'warning');
        });
        
        // Cursor position tracking
        this.elements.codeEditor?.addEventListener('keyup', () => {
            this.updateCursorPosition();
        });
        
        this.elements.codeEditor?.addEventListener('click', () => {
            this.updateCursorPosition();
        });
    }
    
    // ==================== API COMMUNICATION ====================
    async fetchConfig() {
        const response = await fetch('/api/config');
        if (!response.ok) {
            throw new Error(`Config fetch failed: ${response.status}`);
        }
        return await response.json();
    }
    
    async callCodingAPI(prompt) {
        const response = await fetch('/api/coding-agent', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                prompt: prompt,
                currentProject: this.state.project,
                history: this.state.project.conversation.slice(-10)
            })
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || `API Error: ${response.status}`);
        }
        
        return await response.json();
    }
    
    // ==================== PROJECT MANAGEMENT ====================
    async autoLoadLastProject() {
        if (!this.state.userId || !this.state.supabase) return;
        
        try {
            const { data } = await this.state.supabase
                .from('coding_projects')
                .select('*')
                .eq('user_id', this.state.userId)
                .order('updated_at', { ascending: false })
                .limit(1)
                .single();
            
            if (data) {
                this.state.project = {
                    id: data.id,
                    name: data.name,
                    files: data.files || {},
                    conversation: data.conversation || []
                };
                
                this.elements.projectName.value = this.state.project.name;
                this.updateFileTree();
                
                // Restore conversation
                if (this.state.project.conversation.length > 0) {
                    this.elements.chatMessages.innerHTML = '';
                    this.state.project.conversation.forEach(msg => {
                        this.addMessage(
                            msg.role === 'user' ? 'user' : 'bot',
                            msg.role === 'user' ? msg.content : this.formatResponse(msg.content),
                            msg.role !== 'user'
                        );
                    });
                }
                
                // Open first file
                const files = Object.keys(this.state.project.files);
                if (files.length > 0) {
                    this.openFile(files[0]);
                }
                
                this.state.hasUnsavedChanges = false;
                this.refreshPreview();
                console.log('‚úÖ Loaded project:', this.state.project.name);
            }
        } catch (error) {
            console.error('‚ùå Auto-load failed:', error);
        }
    }
    
    // ==================== USER INFO METHODS ====================
    updatePersistentUserInfo() {
        if (!this.elements.persistentUserName || !this.elements.persistentUserStatus) return;
        
        if (this.state.userId) {
            // User is logged in
            this.elements.persistentUserName.textContent = 'Logged In';
            this.elements.persistentUserStatus.textContent = 'Connected';
            if (this.elements.persistentUserStatus.previousElementSibling) {
                this.elements.persistentUserStatus.previousElementSibling.style.background = '#10b981'; // Green dot
            }
        } else {
            // User not logged in
            this.elements.persistentUserName.textContent = 'Guest';
            this.elements.persistentUserStatus.textContent = 'Offline';
            if (this.elements.persistentUserStatus.previousElementSibling) {
                this.elements.persistentUserStatus.previousElementSibling.style.background = '#ef4444'; // Red dot
            }
        }
    }
    
    async saveProject(silent = false) {
        if (!this.state.userId || !this.state.supabase) {
            if (!silent) this.showError('Login required to save projects');
            return false;
        }
        
        try {
            this.updateStatus('SAVING', 'warning');
            
            const projectData = {
                user_id: this.state.userId,
                name: this.elements.projectName.value || 'elite-project',
                files: this.state.project.files,
                conversation: this.state.project.conversation,
                updated_at: new Date().toISOString()
            };
            
            let result;
            if (this.state.project.id) {
                // Update existing project
                result = await this.state.supabase
                    .from('coding_projects')
                    .update(projectData)
                    .eq('id', this.state.project.id)
                    .eq('user_id', this.state.userId)
                    .select()
                    .single();
            } else {
                // Create new project
                result = await this.state.supabase
                    .from('coding_projects')
                    .insert(projectData)
                    .select()
                    .single();
            }
            
            if (result.error) throw result.error;
            
            this.state.project.id = result.data.id;
            this.state.hasUnsavedChanges = false;
            this.updateStatus('SAVED');
            
            if (!silent) {
                this.addMessage('bot', '‚úÖ <strong>Project saved successfully!</strong>');
            }
            
            // Reset status after delay
            setTimeout(() => this.updateStatus('READY'), 2000);
            return true;
            
        } catch (error) {
            console.error('‚ùå Save failed:', error);
            this.updateStatus('ERROR', 'error');
            if (!silent) this.showError(`Save failed: ${error.message}`);
            return false;
        }
    }
    
    // ==================== UI METHODS ====================
    updateStatus(text, type = '') {
        if (this.elements.statusIndicator) {
            this.elements.statusIndicator.textContent = text;
            this.elements.statusIndicator.className = 'status' + (type ? ` ${type}` : '');
        }
    }
    
    addMessage(sender, content, isHtml = false) {
        if (!this.elements.chatMessages) return;
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}`;
        messageDiv.innerHTML = `
            <div class="message-sender">${sender === 'user' ? 'üë§ You' : 'üß† Agent'}</div>
            <div class="message-content">${isHtml ? content : this.escapeHtml(content)}</div>
        `;
        
        this.elements.chatMessages.appendChild(messageDiv);
        this.elements.chatMessages.scrollTop = this.elements.chatMessages.scrollHeight;
    }
    
    showTypingIndicator() {
        if (!this.elements.chatMessages) return null;
        
        const typingDiv = document.createElement('div');
        typingDiv.className = 'message bot';
        typingDiv.id = 'typingIndicator';
        typingDiv.innerHTML = `
            <div class="message-sender">üß† Agent</div>
            <div class="typing-indicator">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        `;
        
        this.elements.chatMessages.appendChild(typingDiv);
        this.elements.chatMessages.scrollTop = this.elements.chatMessages.scrollHeight;
        return typingDiv;
    }
    
    hideTypingIndicator(element) {
        if (element && element.parentNode) {
            element.remove();
        }
    }
    
    updateFileTree() {
        if (!this.elements.fileTree) return;
        
        const files = Object.keys(this.state.project.files).sort();
        
        if (files.length === 0) {
            this.elements.fileTree.innerHTML = `
                <div class="empty-state">
                    No files yet<br>Ask me to build something!
                </div>
            `;
            return;
        }
        
        this.elements.fileTree.innerHTML = files.map(file => `
            <div class="file-item ${this.state.currentFile === file ? 'active' : ''}" 
                 onclick="app.openFile('${file}')">
                <span>${this.getFileIcon(file)}</span>
                <span style="flex:1;overflow:hidden;text-overflow:ellipsis;">${file}</span>
                <button class="file-delete" onclick="event.stopPropagation(); app.deleteFile('${file}')">√ó</button>
            </div>
        `).join('');
    }
    
    getFileIcon(filename) {
        const ext = filename.split('.').pop()?.toLowerCase();
        const icons = {
            'html': 'üåê', 'css': 'üé®', 'js': '‚ö°', 'jsx': '‚öõÔ∏è',
            'ts': 'üìù', 'tsx': '‚öõÔ∏è', 'json': 'üìã', 'md': 'üìù',
            'py': 'üêç', 'java': '‚òï', 'cpp': '‚ö°', 'c': '‚ö°',
            'php': 'üêò', 'sql': 'üìä', 'xml': 'üìã'
        };
        return icons[ext] || 'üìÑ';
    }
    
    openFile(filename) {
        this.state.currentFile = filename;
        const content = this.state.project.files[filename] || '';
        
        if (this.elements.codeEditor) {
            this.elements.codeEditor.value = content;
        }
        
        if (this.elements.fileInfo) {
            this.elements.fileInfo.textContent = filename;
        }
        
        this.updateFileTree();
        this.updateTabs();
        
        if (filename.endsWith('.html')) {
            this.refreshPreview();
        }
    }
    
    updateTabs() {
        if (!this.elements.editorTabs) return;
        
        const files = Object.keys(this.state.project.files);
        const tabs = files.map(file => `
            <div class="tab ${this.state.currentFile === file ? 'active' : ''}" 
                 data-file="${file}" 
                 onclick="app.openFile('${file}')">
                ${this.getFileIcon(file)} ${file}
            </div>
        `).join('');
        
        this.elements.editorTabs.innerHTML = tabs || '<div class="tab active" data-file="welcome">üëã Welcome</div>';
    }
    
    handleCodeChange() {
        if (this.state.currentFile) {
            this.state.project.files[this.state.currentFile] = this.elements.codeEditor.value;
            this.state.hasUnsavedChanges = true;
            this.updateStatus('UNSAVED', 'warning');
            this.refreshPreview();
        }
    }
    
    updateCursorPosition() {
        if (!this.elements.codeEditor || !this.elements.cursorPosition) return;
        
        const textarea = this.elements.codeEditor;
        const text = textarea.value.substring(0, textarea.selectionStart);
        const lines = text.split('\n');
        const line = lines.length;
        const col = lines[lines.length - 1].length + 1;
        
        this.elements.cursorPosition.textContent = `Ln ${line}, Col ${col}`;
    }
    
    // ==================== PREVIEW MODAL METHODS ====================
    togglePreview() {
        if (this.state.previewOpen) {
            this.closePreview();
        } else {
            this.openPreview();
        }
    }
    
    openPreview() {
        this.state.previewOpen = true;
        const overlay = document.getElementById('previewOverlay');
        if (overlay) {
            overlay.classList.add('active');
            this.refreshPreviewModal();
        }
    }
    
    closePreview() {
        this.state.previewOpen = false;
        const overlay = document.getElementById('previewOverlay');
        if (overlay) {
            overlay.classList.remove('active');
        }
    }
    
    refreshPreviewModal() {
        const frame = document.getElementById('previewFrameModal');
        if (!frame) return;
        
        const htmlFiles = Object.keys(this.state.project.files).filter(f => f.endsWith('.html'));
        
        if (htmlFiles.length === 0) {
            frame.srcdoc = '<div style="text-align:center;padding:40px;color:#666;"><h2>No HTML files</h2><p>Create an HTML file first</p></div>';
            return;
        }
        
        const htmlFile = htmlFiles.includes('index.html') ? 'index.html' : htmlFiles[0];
        let html = this.state.project.files[htmlFile] || '';
        
        // Inject CSS and JS
        const cssFiles = Object.keys(this.state.project.files).filter(f => f.endsWith('.css'));
        const jsFiles = Object.keys(this.state.project.files).filter(f => f.endsWith('.js'));
        
        const css = cssFiles.map(f => `<style>/* ${f} */\n${this.state.project.files[f]}</style>`).join('\n');
        const js = jsFiles.map(f => `<script>/* ${f} */\n${this.state.project.files[f]}<\/script>`).join('\n');
        
        if (!html.includes('<html')) {
            html = `<!DOCTYPE html><html><head><meta charset="UTF-8">${css}</head><body>${html}${js}</body></html>`;
        } else {
            if (css && html.includes('</head>')) html = html.replace('</head>', `${css}</head>`);
            if (js && html.includes('</body>')) html = html.replace('</body>', `${js}</body>`);
        }
        
        frame.srcdoc = html;
    }
    
    setPreviewModeModal(mode) {
        this.state.previewMode = mode;
        document.querySelectorAll('.preview-control-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.mode === mode);
        });
        
        const frame = document.getElementById('previewFrameModal');
        if (frame) {
            frame.className = 'preview-frame-full' + (mode !== 'desktop' ? ` ${mode}` : '');
        }
    }
    
    // ==================== DEPRECATED METHODS (kept for backward compatibility) ====================
    setPreviewMode(mode) {
        // Redirect to modal version
        this.setPreviewModeModal(mode);
    }
    
    refreshPreview() {
        // Only refresh if modal is open
        if (this.state.previewOpen) {
            this.refreshPreviewModal();
        }
    }
    
    // ==================== MESSAGE HANDLING ====================
    async sendMessage() {
        const input = this.elements.userInput;
        const button = this.elements.sendButton;
        
        if (!input || !button) return;
        
        const message = input.value.trim();
        if (!message) {
            this.showError('Please enter what you want to build!');
            input.focus();
            return;
        }
        
        if (this.state.isProcessing) {
            this.showError('Already processing a request. Please wait.');
            return;
        }
        
        // Set processing state
        this.state.isProcessing = true;
        input.value = '';
        button.disabled = true;
        this.updateStatus('PROCESSING', 'warning');
        
        // Add user message
        this.addMessage('user', message);
        this.state.project.conversation.push({ role: 'user', content: message });
        
        // Show typing indicator
        const typingElement = this.showTypingIndicator();
        
        try {
            // Call AI API
            const response = await this.callCodingAPI(message);
            
            // Hide typing
            this.hideTypingIndicator(typingElement);
            
            // Process files from response
            if (response.files) {
                Object.entries(response.files).forEach(([filename, content]) => {
                    if (content && content.length > 5) {
                        this.state.project.files[this.cleanFilename(filename)] = content;
                    }
                });
            }
            
            // Extract files from text
            this.extractFilesFromText(response.response);
            
            // Update UI
            this.updateFileTree();
            this.addMessage('bot', this.formatResponse(response.response), true);
            
            this.state.project.conversation.push({
                role: 'assistant',
                content: response.response
            });
            
            this.state.hasUnsavedChanges = true;
            this.updateStatus('UNSAVED', 'warning');
            
            // Auto-open first file if none selected
            const files = Object.keys(this.state.project.files);
            if (files.length > 0 && !this.state.currentFile) {
                const htmlFile = files.find(f => f.endsWith('.html')) || files[0];
                this.openFile(htmlFile);
            }
            
            this.refreshPreview();
            
        } catch (error) {
            console.error('‚ùå Message send failed:', error);
            this.hideTypingIndicator(typingElement);
            this.addMessage('bot', `‚ùå <strong>Error:</strong> ${error.message}`, true);
            this.updateStatus('ERROR', 'error');
        } finally {
            this.state.isProcessing = false;
            button.disabled = false;
            input.focus();
        }
    }
    
    quickAction(prompt) {
        if (this.elements.userInput) {
            this.elements.userInput.value = prompt;
            this.sendMessage();
        }
    }
    
    // ==================== UTILITY METHODS ====================
    cleanFilename(filename) {
        if (filename.length > 50) {
            const match = filename.match(/([a-zA-Z0-9_.-]+\.[a-zA-Z0-9]+)$/);
            return match ? match[1] : `file_${Object.keys(this.state.project.files).length}.txt`;
        }
        return filename.replace(/[<>:"|?*]/g, '');
    }
    
    extractFilesFromText(text) {
        // File extraction patterns
        const patterns = [
            /\*\*üìÑ\s*([^\*\n]+)\*\*\s*```(\w*)\n([\s\S]*?)```/g,
            /üìÑ\s*`?([^`\n]+)`?\s*```(\w*)\n([\s\S]*?)```/g,
            /(?:File|Create|filename)[:\s]*`?([a-zA-Z0-9_\-./]+\.[a-zA-Z0-9]+)`?\s*```(\w*)\n([\s\S]*?)```/gi
        ];
        
        patterns.forEach(pattern => {
            let match;
            while ((match = pattern.exec(text)) !== null) {
                const [, filename, , content] = match;
                if (content?.length > 5) {
                    this.state.project.files[this.cleanFilename(filename.trim())] = content.trim();
                }
            }
        });
        
        // Generic code blocks
        const genericPattern = /```(\w+)\n([\s\S]*?)```/g;
        let match;
        while ((match = genericPattern.exec(text)) !== null) {
            const [, language, code] = match;
            if (code.length < 20) continue;
            
            let filename = null;
            if (code.includes('<!DOCTYPE') || code.includes('<html')) {
                filename = 'index.html';
            } else if (code.includes('"dependencies"')) {
                filename = 'package.json';
            } else if (language === 'css') {
                filename = this.state.project.files['styles.css'] ? 'style.css' : 'styles.css';
            } else if (language === 'javascript' || language === 'js') {
                filename = this.state.project.files['script.js'] ? 'app.js' : 'script.js';
            }
            
            if (filename && !this.state.project.files[filename]) {
                this.state.project.files[filename] = code.trim();
            }
        }
    }
    
    formatResponse(text) {
        return text
            .replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>')
            .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
            .replace(/`([^`]+)`/g, '<code>$1</code>')
            .replace(/^### (.+)$/gm, '<h4>$1</h4>')
            .replace(/^## (.+)$/gm, '<h3>$1</h3>')
            .replace(/^- (.+)$/gm, '<li>$1</li>')
            .replace(/\n\n/g, '</p><p>');
    }
    
    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    showError(message) {
        alert(message); // In production, use a proper toast/notification system
    }
    
    // ==================== PUBLIC METHODS ====================
    newProject() {
        if (this.state.hasUnsavedChanges) {
            if (!confirm('You have unsaved changes. Start a new project anyway?')) {
                return;
            }
        }
        
        this.state.project = { id: null, name: 'new-project', files: {}, conversation: [] };
        this.state.currentFile = null;
        this.state.hasUnsavedChanges = false;
        
        if (this.elements.projectName) {
            this.elements.projectName.value = 'new-project';
        }
        
        if (this.elements.chatMessages) {
            this.elements.chatMessages.innerHTML = `
                <div class="message bot">
                    <div class="message-sender">üß† Agent</div>
                    <div class="message-content">
                        <strong>‚ú® New project started!</strong><br>
                        What would you like to build?
                    </div>
                </div>
            `;
        }
        
        this.updateFileTree();
        this.updateTabs();
        
        if (this.elements.codeEditor) {
            this.elements.codeEditor.value = '// Welcome! Ask the AI to build something.\n// Your code will appear here.';
        }
        
        if (this.elements.fileInfo) {
            this.elements.fileInfo.textContent = 'No file selected';
        }
        
        if (this.elements.previewFrame) {
            this.elements.previewFrame.style.display = 'none';
        }
        
        if (this.elements.previewPlaceholder) {
            this.elements.previewPlaceholder.style.display = 'block';
        }
        
        this.updateStatus('READY');
    }
    
    createFile() {
        const filename = prompt('Enter filename (e.g., index.html):');
        if (filename?.trim()) {
            this.state.project.files[filename.trim()] = '';
            this.updateFileTree();
            this.openFile(filename.trim());
            this.state.hasUnsavedChanges = true;
        }
    }
    
    deleteFile(filename) {
        if (confirm(`Delete ${filename}?`)) {
            delete this.state.project.files[filename];
            this.updateFileTree();
            
            if (this.state.currentFile === filename) {
                this.state.currentFile = null;
                if (this.elements.codeEditor) {
                    this.elements.codeEditor.value = '// Welcome! Ask the AI to build something.\n// Your code will appear here.';
                }
                if (this.elements.fileInfo) {
                    this.elements.fileInfo.textContent = 'No file selected';
                }
            }
            
            this.state.hasUnsavedChanges = true;
            this.refreshPreview();
        }
    }
    
    async loadProjects() {
        if (!this.state.userId) {
            this.showError('Please login first!');
            return;
        }
        
        this.elements.loadModal?.classList.add('active');
        
        const list = this.elements.projectList;
        if (list) {
            list.innerHTML = '<div style="color:#888;padding:16px;text-align:center;">Loading...</div>';
        }
        
        try {
            const { data, error } = await this.state.supabase
                .from('coding_projects')
                .select('id, name, updated_at')
                .eq('user_id', this.state.userId)
                .order('updated_at', { ascending: false });
            
            if (error) throw error;
            
            if (!data?.length) {
                list.innerHTML = '<div style="color:#888;padding:16px;text-align:center;">No saved projects</div>';
                return;
            }
            
            list.innerHTML = data.map(project => `
                <div class="modal-item" onclick="app.loadProject('${project.id}')">
                    <span>üìÅ ${project.name}</span>
                    <span style="color:#666;font-size:11px">
                        ${new Date(project.updated_at).toLocaleDateString()}
                    </span>
                </div>
            `).join('');
            
        } catch (error) {
            console.error('‚ùå Load projects failed:', error);
            list.innerHTML = `<div style="color:#f87171;padding:16px;">Error: ${error.message}</div>`;
        }
    }
    
    async loadProject(projectId) {
        try {
            const { data, error } = await this.state.supabase
                .from('coding_projects')
                .select('*')
                .eq('id', projectId)
                .eq('user_id', this.state.userId)
                .single();
            
            if (error) throw error;
            
            this.state.project = {
                id: data.id,
                name: data.name,
                files: data.files || {},
                conversation: data.conversation || []
            };
            
            if (this.elements.projectName) {
                this.elements.projectName.value = this.state.project.name;
            }
            
            if (this.elements.chatMessages) {
                this.elements.chatMessages.innerHTML = '';
                this.state.project.conversation.forEach(msg => {
                    this.addMessage(
                        msg.role === 'user' ? 'user' : 'bot',
                        msg.role === 'user' ? msg.content : this.formatResponse(msg.content),
                        msg.role !== 'user'
                    );
                });
            }
            
            this.updateFileTree();
            
            const files = Object.keys(this.state.project.files);
            if (files.length > 0) {
                this.openFile(files[0]);
            }
            
            this.closeModal();
            this.state.hasUnsavedChanges = false;
            this.refreshPreview();
            this.updateStatus('LOADED');
            
            setTimeout(() => this.updateStatus('READY'), 2000);
            
        } catch (error) {
            console.error('‚ùå Load project failed:', error);
            this.showError(`Load failed: ${error.message}`);
        }
    }
    
    closeModal() {
        this.elements.loadModal?.classList.remove('active');
    }
    
    async downloadProject() {
        const files = Object.keys(this.state.project.files);
        if (files.length === 0) {
            this.showError('No files to download!');
            return;
        }
        
        try {
            const zip = new JSZip();
            const folder = zip.folder(this.state.project.name || 'project');
            
            files.forEach(filename => {
                folder.file(filename, this.state.project.files[filename]);
            });
            
            const blob = await zip.generateAsync({ type: 'blob' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `${this.state.project.name || 'project'}.zip`;
            a.click();
            
            URL.revokeObjectURL(url);
            
            this.addMessage('bot', `‚úÖ <strong>Downloaded!</strong> Project saved as ZIP with ${files.length} file(s).`, true);
            
        } catch (error) {
            console.error('‚ùå Download failed:', error);
            this.showError(`Download failed: ${error.message}`);
        }
    }
}

// ==================== GLOBAL INSTANCE ====================
const app = new CodingAgent();

// Auto-save every 30 seconds when there are unsaved changes
setInterval(() => {
    if (app.state.hasUnsavedChanges && app.state.userId) {
        app.saveProject(true);
    }
}, 30000);
</script>
</body>
</html>
